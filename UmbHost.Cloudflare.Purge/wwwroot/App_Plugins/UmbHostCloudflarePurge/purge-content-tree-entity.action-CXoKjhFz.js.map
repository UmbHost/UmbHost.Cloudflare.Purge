{"version":3,"file":"purge-content-tree-entity.action-CXoKjhFz.js","sources":["../../../Client/src/trees/purge-content-tree-entity.action.ts"],"sourcesContent":["import { UmbEntityActionArgs, UmbEntityActionBase, UmbRequestReloadStructureForEntityEvent } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UmbModalManagerContext, UMB_MODAL_MANAGER_CONTEXT, UMB_CONFIRM_MODAL } from '@umbraco-cms/backoffice/modal'\r\nimport { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbLocalizationController } from '@umbraco-cms/backoffice/localization-api';\r\nimport { UmbDocumentItemModel, UmbDocumentItemRepository } from '@umbraco-cms/backoffice/document';\r\nimport { UMB_ACTION_EVENT_CONTEXT } from '@umbraco-cms/backoffice/action';\r\nimport { UMB_NOTIFICATION_CONTEXT, UmbNotificationContext, UmbNotificationDefaultData } from '@umbraco-cms/backoffice/notification';\r\nimport { NodeData, V1Resource } from '../backend-api';\r\nimport { UMB_APP_LANGUAGE_CONTEXT, UmbAppLanguageContext } from '@umbraco-cms/backoffice/language';\r\n\r\nexport class PurgeCdnContentEntityAction extends UmbEntityActionBase<never> {\r\n    private _notificationContext?: UmbNotificationContext;\r\n    #modalContext?: UmbModalManagerContext;\r\n    #localize = new UmbLocalizationController(this);\r\n    private _languageContext?: UmbAppLanguageContext;\r\n\r\n    constructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n        super(host, args);\r\n\r\n        this.consumeContext(UMB_APP_LANGUAGE_CONTEXT, (languageConext) => {\r\n            this._languageContext = languageConext;\r\n        });\r\n\r\n        this.consumeContext(UMB_NOTIFICATION_CONTEXT, (notificationContext) => {\r\n              this._notificationContext = notificationContext;\r\n            });\r\n\r\n        this.consumeContext(UMB_MODAL_MANAGER_CONTEXT, (instance) => {\r\n            this.#modalContext = instance;\r\n        });\r\n    }\r\n\r\n    async execute() {\r\n        const item = await this.#getDocument();\r\n        if (!item) return;\r\n\r\n        const modalHandler = this.#modalContext?.open(this, UMB_CONFIRM_MODAL, {\r\n            data: {\r\n                headline: this.#localize.term(\"umbhostCloudflarePurge_confirmpurgecdnentityactiontitle\"),\r\n                content: this.#localize.string(\"#umbhostCloudflarePurge_confirmpurgecdnentityactioncontent\", item.name),\r\n                color: 'danger',\r\n            }\r\n        });\r\n\r\n        await modalHandler?.onSubmit().then(() => {\r\n            this.#handPurge(item).then((result) => {\r\n                if (result) {\r\n                    const data: UmbNotificationDefaultData = { headline: this.#localize.string(\"#umbhostCloudflarePurge_purgeitemsuccesstitle\", item.name), message: this.#localize.term(\"umbhostCloudflarePurge_purgeitemsuccesscontent\") };\r\n                        this._notificationContext?.peek('positive', { data });\r\n                }else{\r\n                    const data: UmbNotificationDefaultData = { headline: this.#localize.string(\"#umbhostCloudflarePurge_purgeitemfailedtitle\", item.name), message: this.#localize.term(\"umbhostCloudflarePurge_purgeitemfailedcontent\") };\r\n                        this._notificationContext?.peek('danger', { data });\r\n                }\r\n            });\r\n\r\n                  this.#notify();\r\n        }).catch(() => {\r\n        });\r\n    }\r\n\r\n    async #handPurge(item: UmbDocumentItemModel) : Promise<boolean> {\r\n\r\n        let cultureName = undefined;\r\n        if (this._languageContext) {\r\n            cultureName = this._languageContext.getAppCulture();\r\n        }\r\n\r\n        const nodeData: NodeData = {\r\n\t\t\t\trequestBody: {\r\n                    unique: item.unique,\r\n                    culture: cultureName\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n            V1Resource.node(nodeData).then(() => {\r\n                return true;\r\n            }).catch(() => {\r\n                return false;\r\n            });\r\n\r\n        return false;\r\n    }\r\n\r\n    async #getDocument() {\r\n        if (!this.args.unique) throw new Error('Cannot purge an item without a unique identifier.');\r\n\r\n\t\tconst { data } = await new UmbDocumentItemRepository(this).requestItems([this.args.unique]);\r\n\t\tconst item = data?.[0];\r\n\t\tif (!item) throw new Error('Item not found.');\r\n\t\treturn item;\r\n\t}\r\n\r\n    async #notify() {\r\n\t\tconst actionEventContext = await this.getContext(UMB_ACTION_EVENT_CONTEXT);\r\n\t\tif (!actionEventContext) {\r\n\t\t\tthrow new Error('Action event context not found.');\r\n\t\t}\r\n\r\n\t\tconst event = new UmbRequestReloadStructureForEntityEvent({\r\n\t\t\tunique: this.args.unique,\r\n\t\t\tentityType: this.args.entityType,\r\n\t\t});\r\n\r\n\t\tactionEventContext.dispatchEvent(event);\r\n\t}\r\n}\r\n\r\nexport { PurgeCdnContentEntityAction as api };"],"names":["PurgeCdnContentEntityAction","UmbEntityActionBase","host","args","__privateAdd","_PurgeCdnContentEntityAction_instances","_modalContext","_localize","UmbLocalizationController","UMB_APP_LANGUAGE_CONTEXT","languageConext","UMB_NOTIFICATION_CONTEXT","notificationContext","UMB_MODAL_MANAGER_CONTEXT","instance","__privateSet","item","__privateMethod","getDocument_fn","modalHandler","_a","__privateGet","UMB_CONFIRM_MODAL","handPurge_fn","result","data","_b","notify_fn","cultureName","nodeData","V1Resource","UmbDocumentItemRepository","actionEventContext","UMB_ACTION_EVENT_CONTEXT","event","UmbRequestReloadStructureForEntityEvent"],"mappings":"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"}